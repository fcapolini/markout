name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          # Ensure consistent line endings across platforms
          autocrlf: false

      - name: Use Node.js 20.x
        uses: actions/setup-node@v5
        with:
          node-version: 20.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract version from tag (remove refs/tags/ prefix)
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          # Markout ${VERSION} - Alpha Release ğŸš§

          First alpha release of Markout CLI published to npm as `@markout-js/cli`

          ## ğŸ¯ What is Markout?

          HTML-first reactive web framework for Node.js and the browser â€” for devs who despise _needless complexity_.

          ## ğŸ“¦ Installation

          ```bash
          # Install globally via npm
          npm install -g @markout-js/cli

          # Or run directly with npx
          npx @markout-js/cli serve . --port 3000
          ```

          ## âœ¨ Features

          - **HTML-first approach**: Build on HTML rather than replacing it with JavaScript
          - **Logic values**: `:count`, `:on-click`, `:class-`, `:style-` for reactive state  
          - **Reactive expressions**: `${...}` syntax for dynamic content
          - **Server-side rendering**: Pre-rendered pages with client-side hydration
          - **CLI development server**: Hot reload and Express.js backend
          - **Components**: `<:define>` with slots for reusable UI elements
          - **Fragments**: `<:import>` for modular HTML organization
          - **Looping**: `:foreach` attribute and `<template :foreach>`
          - **Production ready**: PM2 process management and deployment support

          ## ğŸš€ Quick Start

          Create `hello.html`:
          ```html
          <html>
            <body>
              <button :count="${0}" :on-click="${() => count++}">
                Clicks: ${count}
              </button>
            </body>
          </html>
          ```

          Serve it:
          ```bash
          markout serve .
          ```

          Open `http://localhost:3000` - you have a working reactive app!

          ## âš ï¸ Alpha Status

          **Core features working, some features still in development:**

          - âœ… Logic values, reactive expressions, looping, components, fragments
          - âœ… SSR/CSR, development server, production deployment  
          - ğŸš§ Runtime component system improvements
          - âŒ Conditionals (`<template :if>`), Data services (`<:data>`), VS Code extension

          See [ROADMAP.md](ROADMAP.md) for complete development timeline.

          ## ğŸ“š Documentation

          - [README.md](README.md) - Framework overview and examples
          - [INSTALL.md](INSTALL.md) - Installation and quick start guide  
          - [ROADMAP.md](ROADMAP.md) - Development timeline and feature status

          ## ğŸ› Known Issues

          - Template literal compilation issue with falsy values (being debugged)
          - API may change during alpha - migration guides provided for breaking changes

          ## ğŸ’ Feedback Welcome

          This is an alpha release - your feedback helps shape the framework:
          - ğŸ› [Report bugs](https://github.com/fcapolini/markout/issues)
          - ğŸ’¡ [Request features](https://github.com/fcapolini/markout/issues)  
          - ğŸ’¬ [Join discussions](https://github.com/fcapolini/markout/discussions)

          ---

          **Package:** [@markout-js/cli](https://www.npmjs.com/package/@markout-js/cli)  
          **Size:** 815KB (will be optimized in future releases)  
          **Node.js:** 18+ required
          EOF

          # Create the release
          gh release create $VERSION \
            --title "Markout $VERSION - Alpha CLI Package" \
            --notes-file release_notes.md \
            --prerelease

    # Uncomment when ready to publish to npm
    # - name: Publish to npm
    #   run: npm publish
    #   env:
    #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
